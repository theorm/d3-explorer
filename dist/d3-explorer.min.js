!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("core-js/modules/es6.regexp.replace"),require("lodash-es"),require("d3"),require("core-js/modules/es6.regexp.to-string"),require("core-js/modules/es6.object.to-string")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es6.regexp.replace","lodash-es","d3","core-js/modules/es6.regexp.to-string","core-js/modules/es6.object.to-string"],e):e((t=t||self)["d3-explorer"]=t["d3-explorer"]||{},null,t._,t.d3)}(this,function(t,e,n,r){"use strict";function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function o(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}function s(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&c(t,e)}function l(t){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function c(t,e){return(c=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function u(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function f(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=[],r=!0,a=!1,i=void 0;try{for(var o,s=t[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!e||n.length!==e);r=!0);}catch(t){a=!0,i=t}finally{try{r||null==s.return||s.return()}finally{if(a)throw i}}return n}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function d(t,e){t||(new Error("[Assertion error]: ".concat(e)).assert=!0)}function h(){var t;(t=console).warn.apply(t,arguments)}var g=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};a(this,t),this.title=n.get(e,"title","")}return o(t,[{key:"getTitle",value:function(){return this.title}},{key:"renderLabels",value:function(t,e,n,r,a){}},{key:"renderStep",value:function(t,e,n,r,a,i,o){}},{key:"renderOverlay",value:function(t,e,n,r){}}]),t}(),p={labels:{offset:150,margin:5},margin:{left:10,right:10,top:10,bottom:10},colours:{bin:{highlight:"#dddddd22",selected:"#ffff0033",midline:"#eaeaea"},separator:{line:"#bbb",textBackground:"#ffffffbb"}},handlers:{}},v=["labels","bins","separators","overlays"],m=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};a(this,t),d(!n.isNil(i),"Options must be an object"),this.container=r.select(e),this.svg=this.container.append("svg"),i.class&&this.svg.attr("class",i.class);var o=this.container.node().getBoundingClientRect(),s=o.width,l=o.height;0===s&&h("Width of the SVG container is ".concat(s)),0===l&&h("Height of the SVG container is ".concat(l)),this.parameters=n.assignIn({},p,i.parameters),this.plots=[],this.data={}}return o(t,[{key:"_getWH",value:function(){var t=this.container.node().getBoundingClientRect();return{width:t.width,height:t.height}}},{key:"render",value:function(){var t=this,e=this._getWH(),n=e.width,a=e.height,i=this.getBinsCount();this.svg.attr("width",n).attr("height",a);var o=[this.getLabelsGroupsData(),r.range(i),this.getPlotsTitlesData(),r.range(this.plots.length)];this.svg.selectAll("g.toplevel").data(o).join("g").attr("class",function(t,e){return"toplevel ".concat(v[e])}).each(function(e,n,a){var i=r.select(a[n]);return 0===n?t._renderLabels(i):1===n?t._renderBins(i):2===n?t._renderSeparators(i):3===n?t._renderOverlay(i):void 0})}},{key:"getBinWidth",value:function(){var t=this._getWH().width,e=this.getBinsCount(),n=this.parameters,r=n.margin,a=n.labels;return(t-r.left-r.right-a.offset)/e}},{key:"getBinsCount",value:function(){var t=this;return this.plots.reduce(function(e,r){var a=f(r,1)[0],i=n.get(t.data[a],"data",[]).length;return i>e?i:e},0)}},{key:"getMaximumOptimalBinsCount",value:function(){var t=this._getWH().width,e=this.parameters,n=e.margin,r=t-e.labels.offset-n.left-n.right,a=Math.floor(r/20);return a>0?a:0}},{key:"getGroupsData",value:function(){var t=this;return this.plots.map(function(e){var r=f(e,1)[0];return n.get(t.data[r],"data",[])})}},{key:"getDataForGroup",value:function(t){return n.get(this.data[t],"data",[])}},{key:"getLabelsGroupsData",value:function(){var t=this;return this.plots.map(function(e){var r=f(e,1)[0];return n.get(t.data[r],"labels",[])})}},{key:"getPlotsTitlesData",value:function(){return this.plots.map(function(t){return f(t,2)[1].getTitle()})}},{key:"getUnitSize",value:function(){var t=this._getWH().height,e=this.parameters.margin;return(t-e.top-e.bottom)/(this.plots.reduce(function(t,e){return t+f(e,3)[2]},0)||1)}},{key:"_renderLabels",value:function(t){var e=this,n=this.parameters.margin,a=t.selectAll("g.label-group").data(this._dataWithRenderMeta.bind(this)).join("g").attr("class",function(t){var e=t.id;return"label-group ".concat(e.replace(" ","-"))}).attr("transform",function(t){var r=t.unitsOffset;return"translate(0, ".concat(r*e.getUnitSize()+n.top,")")}),i=this;a.each(function(t){var e=t.id,n=t.units,a=t.data;t.plot.renderLabels(r.select(this),e,n,a,i)})}},{key:"_renderBins",value:function(t){var e=this,a=this._getWH(),i=a.width,o=a.height,s=this.parameters,l=this.getBinWidth(),c=this.parameters,u=c.margin,f=c.labels,d=r.scaleLinear().domain([0,t.data()[0].length]).rangeRound([0,i-u.right-u.left-f.offset]),h=function(){return!this.classList.contains("selected")},g=t.style("pointer-events","all").attr("transform","translate(".concat(this.parameters.labels.offset+u.left,", 0)")).selectAll("g.step").data(function(t){return t}).join("g").attr("class","step").attr("transform",function(t,e){return"translate(".concat(d(e),", 0)")}).on("mouseover",function(t,e){r.select(this).select(".highlight").filter(h).style("fill",s.colours.bin.highlight),this.selectedBin=e;var a=s.handlers.onBinOver;(void 0===a?n.noop:a)(e)}).on("mouseout",function(t,e){r.select(this).select(".highlight").filter(h).style("fill","none"),this.selectedBin=e;var a=s.handlers.onBinOut;(void 0===a?n.noop:a)(e)}).on("click",function(t,r){e.selectedBin=r;var a=s.handlers.onBinSelected;(void 0===a?n.noop:a)(r),e.render()});g.selectAll("line.midline").data([null]).join("line").attr("class","midline").attr("stroke",s.colours.bin.midline).attr("x1",l/2).attr("x2",l/2).attr("y1",u.top).attr("y2",o-u.top-u.bottom),g.selectAll("rect.highlight").data(function(t,e){return[{stepIndex:e}]}).join("rect").attr("class",function(t){return t.stepIndex===e.selectedBin?"highlight selected":"highlight"}).style("fill",function(t){return t.stepIndex===e.selectedBin?s.colours.bin.selected:"none"}).attr("x",0).attr("y",u.top).attr("width",l).attr("height",o-u.top-u.bottom);var p=g.selectAll("g.plots").data(function(t){return[t]}).join("g").attr("class","plots"),v=this;p.selectAll("g.plot").data(function(t,r){var a=e.getGroupsData().map(function(t){return n.get(t,r)});return e._dataWithRenderMeta.bind(e)(a).map(function(t){return t.stepIndex=r,t})},function(t){return t.id}).join("g").attr("class",function(t){var e=t.id;return"plot ".concat(e.replace(" ","-"))}).attr("transform",function(t){var n=t.unitsOffset;return"translate(0, ".concat(n*e.getUnitSize()+u.top,")")}).each(function(t){var e=t.id,a=t.plot,i=t.units,o=t.stepIndex;a.renderStep(r.select(this),e,i,n.get(v.data[e],"data",[]),o,v,d(o))})}},{key:"_renderSeparators",value:function(t){var e=this,n=this.parameters,a=n.margin,i=n.colours,o=this._getWH().width,s=t.selectAll("g.separator").data(this._dataWithRenderMeta.bind(this)).join("g").attr("class",function(t){var e=t.id;return"separator ".concat(e.replace(" ","-"))}).attr("transform",function(t){var n=t.unitsOffset;return"translate(0, ".concat(n*e.getUnitSize()+a.top,")")});s.selectAll("line").data(function(t){return[t]}).join("line").attr("stroke",i.separator.line).attr("stroke-dasharray",4).attr("x1",a.left).attr("x2",o-a.right);var l=a.left+(o-a.left-a.right)/2;s.selectAll("rect").data(function(t){return[t]}).join("rect").attr("fill",i.separator.textBackground).attr("x",l-8).attr("y",-8).attr("width",100).attr("height",20),s.selectAll("text").data(function(t){return[t]}).join("text").attr("dy",4).attr("x",l).text(function(t){return t.data}),r.zip(s.selectAll("rect").nodes(),s.selectAll("text").nodes()).forEach(function(t){var e=f(t,2),n=e[0],a=e[1].getBoundingClientRect().width;r.select(n).attr("width",a+16)})}},{key:"_renderOverlay",value:function(t){var e=this,n=this.parameters.margin,a=t.style("pointer-events","all").attr("transform","translate(".concat(this.parameters.labels.offset+n.left,", 0)")).selectAll("g.overlay").data(this._dataWithRenderMeta.bind(this)).join("g").attr("class",function(t){var e=t.id;return"overlay ".concat(e.replace(" ","-"))}).attr("transform",function(t){var r=t.unitsOffset;return"translate(0, ".concat(r*e.getUnitSize()+n.top,")")}),i=this;a.each(function(t){var e=t.id,n=t.units;t.plot.renderOverlay(r.select(this),e,n,i)})}},{key:"_dataWithRenderMeta",value:function(t){var e=this;return t.map(function(t,n){var r=e.plots.slice(0,n).reduce(function(t,e){return t+f(e,3)[2]},0),a=f(e.plots[n],3);return{data:t,id:a[0],plot:a[1],units:a[2],unitsOffset:r}})}},{key:"getOverlayForPlot",value:function(t){var e=this.plots.map(function(t){return f(t,1)[0]}).indexOf(t);return this.svg.selectAll("g.overlay:nth-child(".concat(e+1,")"))}},{key:"addPlot",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};d(!n.isNil(e),"Options must be an object"),d(t instanceof g,'Plot is not a "Plot" instance: '.concat(t));var r=this.plots.length,a=e.units,i=void 0===a?1:a,o=e.id,s=void 0===o?"plot-".concat(r):o;return d(0===this.plots.filter(function(t){return t[0]===s}).length,'Plot with ID "'.concat(s,'" already exists')),this.plots.push([s,t,i]),this.render(),s}},{key:"removePlot",value:function(t){this.plots=this.plots.filter(function(e){return f(e,1)[0]!==t}),this.render()}},{key:"getPlotIds",value:function(){return this.plots.map(function(t){return f(t,1)[0]})}},{key:"setLabels",value:function(t,e){d(n.includes(this.getPlotIds(),t),'Unknown plot ID: "'.concat(t,'"')),d(n.isArray(e),"Labels must be an array but is: ".concat(e));var r=n.get(this.data,t,{});r.labels=e,this.data[t]=r,this.render()}},{key:"setData",value:function(t,e){d(n.includes(this.getPlotIds(),t),'Unknown plot ID: "'.concat(t,'"')),d(n.isArray(e),"Data must be an array but is: ".concat(e));var r=n.get(this.data,t,{});r.data=e,this.data[t]=r,this.render()}},{key:"setSelectedBin",value:function(t){this.selectedBin=t,this.render()}}]),t}(),y=function(t){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return a(this,e),(t=u(this,l(e).call(this,n))).margin=n.margin||{top:10,bottom:10},t.handlers=n.handlers||{},t.colours=n.colours||{overlay:{selected:"#3333330f"},value:{outlierAbove:"#00ff33",outlierBelow:"#ff0000",mean:"#eeeeee"}},t.fontSize=n.fontSize||10,t}return s(e,g),o(e,[{key:"renderLabels",value:function(t,e,a,i,o){var s=o.getUnitSize()*a,l=o.parameters.labels,c=l.offset,u=l.margin,f=r.scalePoint().domain(r.range(i.length)).rangeRound([this.margin.top,s-this.margin.bottom]).padding(.5);t.selectAll("text").data(function(t){return t.data}).join("text").attr("transform",function(t,e){return"translate(0, ".concat(f(e),")")}).attr("dy","0.35em").attr("x",c-u).attr("text-anchor","end").style("font-size","".concat(this.fontSize,"px")).style("cursor","pointer").text(function(t){return t}).on("click",function(t,r){var a=o.parameters.handlers.onLabelClicked;(void 0===a?n.noop:a)(e,r)}).on("mouseover",function(){r.select(this).attr("font-weight","bold")}).on("mouseout",function(){r.select(this).attr("font-weight",void 0)})}},{key:"renderStep",value:function(t,e,a,i,o,s){var l=this,c=s.getUnitSize()*a,u=c-this.margin.top-this.margin.bottom,f=(i[o]||[]).length,d=u/f,h=s.getBinWidth(),g=n.min([d,h])/2*.95,p=r.scalePoint().domain(r.range(f)).rangeRound([this.margin.top,c-this.margin.bottom]).padding(.5);t.selectAll("g.values").data(function(t){return[t.data||[]]}).join("g").attr("class","values").attr("transform","translate(".concat(h/2,", 0)")).selectAll("circle").data(function(t){var e=r.deviation(t),n=r.mean(t);return t.map(function(t){return{val:t,mean:n,std:e}})}).join("circle").attr("cx",0).attr("cy",function(t,e){return p(e)}).attr("fill",function(t){return l._getColour(t)}).attr("r",function(t){return parseFloat(t.val)>0?t.val*g:0});var v=this.colours;t.selectAll("g.hotspots").data(function(t){return[t.data||[]]}).join("g").attr("class","hotspots").attr("transform","translate(".concat(h/2,", 0)")).selectAll("circle").data(function(t,e){return t.map(function(t){return{value:t,stepIndex:e}})}).join("circle").attr("cy",function(t,e){return p(e)}).attr("fill","none").attr("r",g).on("mouseover",function(){r.select(this).style("fill",v.overlay.selected)}).on("mouseout",function(){r.select(this).style("fill","none")}).on("click",function(t,r){var a=l.handlers.onValueClicked;(void 0===a?n.noop:a)(e,r,o)})}},{key:"_getColour",value:function(t){if(n.isNaN(t.val))return"none";var e=this.colours.value,r=e.outlierAbove,a=e.outlierBelow,i=e.mean,o=t.val>t.mean+t.std?r:t.val<t.mean-t.std?a:i,s=2*Math.abs(t.val-t.mean);s>1&&(s=1),s<0&&(s=0);var l=(55+Math.round(200*s)).toString(16);return o+(1===l.length?"0".concat(l):l)}}]),e}(),b=function(t){return n.isArray(t)?t[0]:t},x=function(t){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return a(this,e),(t=u(this,l(e).call(this,n))).margin=n.margin||{top:10,bottom:1,left:2,right:2},t.handlers=n.handlers||{},t.colours=n.colours||{bars:["#99999955","#999999"],font:"#550",bubble:"#bbbbbbcc"},t.fontSize=n.fontSize||10,t}return s(e,g),o(e,[{key:"renderLabels",value:function(t,e,a,i,o){var s=this,l=o.getUnitSize()*a,c=o.parameters.labels,u=c.offset,f=c.margin,d=r.scalePoint().domain(r.range(i.length)).rangeRound([this.margin.top,l-this.margin.bottom]).padding(.5),h=t.selectAll("g.label").data(function(t){return n.reverse(n.clone(t.data))}).join("g").attr("class","label").attr("transform",function(t,e){return"translate(".concat(u-f-5,", ").concat(d(e),")")}).attr("dy","0.35em");h.selectAll("text").data(function(t){return[t]}).join("text").attr("text-anchor","end").text(function(t){return t});h.selectAll("rect").data(function(t,e){return[e]}).join("rect").attr("x",4).attr("y",-10).attr("width",10).attr("height",10).attr("fill",function(t){return s.colours.bars[t]})}},{key:"renderStep",value:function(t,e,a,i,o,s,l){var c=this,u=s.getUnitSize()*a,f=s.getBinWidth(),d=.9*f,h=(f-d)/2,g=u-this.margin.bottom-this.margin.top,p=r.scaleLinear().domain([0,1]).range([g,0]);t.on("mouseover",function(t){var r=s.getOverlayForPlot(e),a=t.data;r.selectAll("g.hotspot").attr("opacity",1).attr("transform","translate(".concat(l,", ").concat(2.5*-c.fontSize,")")).selectAll("text").data(n.reverse(n.clone(a))).join("text").attr("text-anchor","middle").attr("dy",function(t,e){return c.fontSize*(e+1)+c.fontSize/2}).attr("dx",f/2).style("font-size","".concat(c.fontSize,"px")).style("font-weight","bold").text(function(t){var e=function(t){return n.isArray(t)?t[1]:void 0}(t),r=b(t);return n.round(n.isFinite(e)?e:r,2)}).attr("fill",c.colours.text).style("cursor","default")}).on("mouseout",function(){s.getOverlayForPlot(e).selectAll("g.hotspot").attr("opacity",0)}),t.selectAll("rect").data(function(t){return n.reverse(n.clone(t.data||[]))}).join("rect").attr("x",h).attr("y",function(t){return c.margin.top+p(b(t)||0)}).attr("width",d).attr("height",function(t){return g-p(b(t)||0)}).attr("fill",function(t,e){return c.colours.bars[e]})}},{key:"renderOverlay",value:function(t,e,r,a){var i=a.getBinWidth(),o=a.getUnitSize()*r;if(n.isFinite(i)){var s=t.selectAll("g.hotspot").data([null]).join("g").attr("class","hotspot").attr("transform","translate(".concat(i/2+1,", ").concat(o,")")).attr("opacity",0),l=3*this.fontSize;s.selectAll("rect").data(function(t){return[t]}).join("rect").attr("fill",this.colours.bubble).attr("width",l).attr("height",l).attr("x",-l/2+i/2).attr("rx",.3*l)}}}]),e}();t.BarPlot=x,t.Explorer=m,t.HeatBubblePlot=y,Object.defineProperty(t,"__esModule",{value:!0})});
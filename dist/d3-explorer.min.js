!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("lodash-es"),require("d3")):"function"==typeof define&&define.amd?define(["exports","lodash-es","d3"],e):e((t=t||self)["d3-explorer"]=t["d3-explorer"]||{},t._,t.d3)}(this,function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function a(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function i(t,e,n){return e&&a(t.prototype,e),n&&a(t,n),t}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&l(t,e)}function s(t){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function l(t,e){return(l=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function c(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function u(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=[],r=!0,a=!1,i=void 0;try{for(var o,s=t[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!e||n.length!==e);r=!0);}catch(t){a=!0,i=t}finally{try{r||null==s.return||s.return()}finally{if(a)throw i}}return n}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function f(t,e){t||(new Error("[Assertion error]: ".concat(e)).assert=!0)}function h(){var t;(t=console).warn.apply(t,arguments)}var d=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r(this,t),this.title=e.get(n,"title","")}return i(t,[{key:"getTitle",value:function(){return this.title}},{key:"renderLabels",value:function(t,e,n,r,a){}},{key:"renderStep",value:function(t,e,n,r,a,i,o,s){}},{key:"renderOverlay",value:function(t,e,n,r){}}]),t}(),g={labels:{offset:150,margin:5},margin:{left:10,right:10,top:10,bottom:10},colours:{bin:{highlight:"#dddddd22",selected:"#ffff0033",midline:"#eaeaea"},separator:{line:"#bbb",textBackground:"#ffffffbb"}},handlers:{}},p=["labels","bins","separators","overlays"],v=function(){function t(a){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};r(this,t),f(!e.isNil(i),"Options must be an object"),this.container=n.select(a),this.svg=this.container.append("svg"),i.class&&this.svg.attr("class",i.class);var o=this.container.node().getBoundingClientRect(),s=o.width,l=o.height;0===s&&h("Width of the SVG container is ".concat(s)),0===l&&h("Height of the SVG container is ".concat(l)),this.parameters=e.assignIn({},g,i.parameters),this.plots=[],this.data={},this.maxValues={}}return i(t,[{key:"_getWH",value:function(){var t=this.container.node().getBoundingClientRect();return{width:t.width,height:t.height}}},{key:"render",value:function(){var t=this,r=this._getWH(),a=r.width,i=r.height,o=this.getBinsCount();this.svg.attr("width",a).attr("height",i);var s=[this.getLabelsGroupsData(),n.range(o),this.getPlotsTitlesData(),n.range(this.plots.length)];this.svg.selectAll("g.toplevel").data(s).join("g").attr("class",function(t,e){return"toplevel ".concat(p[e])}).each(function(e,r,a){var i=n.select(a[r]);return 0===r?t._renderLabels(i):1===r?t._renderBins(i):2===r?t._renderSeparators(i):3===r?t._renderOverlay(i):void 0});var l=this.parameters.handlers.onRendered;(void 0===l?e.noop:l)()}},{key:"getBinWidth",value:function(){var t=this._getWH().width,e=this.getBinsCount(),n=this.parameters,r=n.margin,a=n.labels;return(t-r.left-r.right-a.offset)/e}},{key:"getBinsCount",value:function(){var t=this;return this.plots.reduce(function(n,r){var a=u(r,1)[0],i=e.get(t.data[a],"data",[]).length;return i>n?i:n},0)}},{key:"getMaximumOptimalBinsCount",value:function(){var t=this._getWH().width,e=this.parameters,n=e.margin,r=t-e.labels.offset-n.left-n.right,a=Math.floor(r/20);return a>0?a:0}},{key:"getGroupsData",value:function(){var t=this;return this.plots.map(function(n){var r=u(n,1)[0];return e.get(t.data[r],"data",[])})}},{key:"getDataForGroup",value:function(t){return e.get(this.data[t],"data",[])}},{key:"getLabelsGroupsData",value:function(){var t=this;return this.plots.map(function(n){var r=u(n,1)[0];return e.get(t.data[r],"labels",[])})}},{key:"getPlotsTitlesData",value:function(){return this.plots.map(function(t){return u(t,2)[1].getTitle()})}},{key:"getUnitSize",value:function(){var t=this._getWH().height,e=this.parameters.margin;return(t-e.top-e.bottom)/(this.plots.reduce(function(t,e){return t+u(e,3)[2]},0)||1)}},{key:"_renderLabels",value:function(t){var e=this,r=this.parameters.margin,a=t.selectAll("g.label-group").data(this._dataWithRenderMeta.bind(this)).join("g").attr("class",function(t){var e=t.id;return"label-group ".concat(e.replace(" ","-"))}).attr("transform",function(t){var n=t.unitsOffset;return"translate(0, ".concat(n*e.getUnitSize()+r.top,")")}),i=this;a.each(function(t){var e=t.id,r=t.units,a=t.data;t.plot.renderLabels(n.select(this),e,r,a,i)})}},{key:"_renderBins",value:function(t){var r=this,a=this._getWH(),i=a.width,o=a.height,s=this.parameters,l=this.getBinWidth(),c=this.parameters,u=c.margin,f=c.labels,h=n.scaleLinear().domain([0,t.data()[0].length]).rangeRound([0,i-u.right-u.left-f.offset]),d=function(){return!this.classList.contains("selected")},g=t.style("pointer-events","all").attr("transform","translate(".concat(this.parameters.labels.offset+u.left,", 0)")).selectAll("g.step").data(function(t){return t}).join("g").attr("class","step").attr("transform",function(t,e){return"translate(".concat(h(e),", 0)")}).on("mouseover",function(t,r){n.select(this).select(".highlight").filter(d).style("fill",s.colours.bin.highlight),this.selectedBin=r;var a=s.handlers.onBinOver;(void 0===a?e.noop:a)(r)}).on("mouseout",function(t,r){n.select(this).select(".highlight").filter(d).style("fill","none"),this.selectedBin=r;var a=s.handlers.onBinOut;(void 0===a?e.noop:a)(r)}).on("click",function(t,n){r.selectedBin=n;var a=s.handlers.onBinSelected;(void 0===a?e.noop:a)(n),r.render()});g.selectAll("line.midline").data([null]).join("line").attr("class","midline").attr("stroke",s.colours.bin.midline).attr("x1",l/2).attr("x2",l/2).attr("y1",u.top).attr("y2",o-u.top-u.bottom),g.selectAll("rect.highlight").data(function(t,e){return[{stepIndex:e}]}).join("rect").attr("class",function(t){return t.stepIndex===r.selectedBin?"highlight selected":"highlight"}).style("fill",function(t){return t.stepIndex===r.selectedBin?s.colours.bin.selected:"none"}).attr("x",0).attr("y",u.top).attr("width",l).attr("height",o-u.top-u.bottom);var p=g.selectAll("g.plots").data(function(t){return[t]}).join("g").attr("class","plots"),v=this;p.selectAll("g.plot").data(function(t,n){var a=r.getGroupsData().map(function(t){return e.get(t,n)});return r._dataWithRenderMeta.bind(r)(a).map(function(t){return t.stepIndex=n,t})},function(t){return t.id}).join("g").attr("class",function(t){var e=t.id;return"plot ".concat(e.replace(" ","-"))}).attr("transform",function(t){var e=t.unitsOffset;return"translate(0, ".concat(e*r.getUnitSize()+u.top,")")}).each(function(t){var r=t.id,a=t.plot,i=t.units,o=t.stepIndex,s=v.maxValues[r];a.renderStep(n.select(this),r,i,e.get(v.data[r],"data",[]),o,v,h(o),s)})}},{key:"_renderSeparators",value:function(t){var e=this,r=this.parameters,a=r.margin,i=r.colours,o=this._getWH().width,s=t.selectAll("g.separator").data(this._dataWithRenderMeta.bind(this)).join("g").attr("class",function(t){var e=t.id;return"separator ".concat(e.replace(" ","-"))}).attr("transform",function(t){var n=t.unitsOffset;return"translate(0, ".concat(n*e.getUnitSize()+a.top,")")});s.selectAll("line").data(function(t){return[t]}).join("line").attr("stroke",i.separator.line).attr("stroke-dasharray",4).attr("x1",a.left).attr("x2",o-a.right);var l=a.left+(o-a.left-a.right)/2;s.selectAll("rect").data(function(t){return[t]}).join("rect").attr("fill",i.separator.textBackground).attr("x",l-8).attr("y",-8).attr("width",100).attr("height",20),s.selectAll("text").data(function(t){return[t]}).join("text").attr("dy",4).attr("x",l).text(function(t){return t.data}),n.zip(s.selectAll("rect").nodes(),s.selectAll("text").nodes()).forEach(function(t){var e=u(t,2),r=e[0],a=e[1].getBoundingClientRect().width;n.select(r).attr("width",a+16)})}},{key:"_renderOverlay",value:function(t){var e=this,r=this.parameters.margin,a=t.style("pointer-events","all").attr("transform","translate(".concat(this.parameters.labels.offset+r.left,", 0)")).selectAll("g.overlay").data(this._dataWithRenderMeta.bind(this)).join("g").attr("class",function(t){var e=t.id;return"overlay ".concat(e.replace(" ","-"))}).attr("transform",function(t){var n=t.unitsOffset;return"translate(0, ".concat(n*e.getUnitSize()+r.top,")")}),i=this;a.each(function(t){var e=t.id,r=t.units;t.plot.renderOverlay(n.select(this),e,r,i)})}},{key:"_dataWithRenderMeta",value:function(t){var n=this;return(e.isArray(t)?t:[t]).map(function(t,r){var a=n.plots.slice(0,r).reduce(function(t,e){return t+u(e,3)[2]},0),i=u(n.plots[r],3),o=i[0],s=i[1],l=i[2];return{data:e.isArray(t)?t:[t],id:o,plot:s,units:l,unitsOffset:a}})}},{key:"getOverlayForPlot",value:function(t){var e=this.plots.map(function(t){return u(t,1)[0]}).indexOf(t);return this.svg.selectAll("g.overlay:nth-child(".concat(e+1,")"))}},{key:"addPlot",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};f(!e.isNil(n),"Options must be an object"),f(t instanceof d,'Plot is not a "Plot" instance: '.concat(t));var r=this.plots.length,a=n.units,i=void 0===a?1:a,o=n.id,s=void 0===o?"plot-".concat(r):o;return f(0===this.plots.filter(function(t){return t[0]===s}).length,'Plot with ID "'.concat(s,'" already exists')),this.plots.push([s,t,i]),this.render(),s}},{key:"removePlot",value:function(t){this.plots=this.plots.filter(function(e){return u(e,1)[0]!==t}),this.render()}},{key:"getPlotIds",value:function(){return this.plots.map(function(t){return u(t,1)[0]})}},{key:"setLabels",value:function(t,n){f(e.includes(this.getPlotIds(),t),'Unknown plot ID: "'.concat(t,'"')),f(e.isArray(n),"Labels must be an array but is: ".concat(n));var r=e.get(this.data,t,{});r.labels=n,this.data[t]=r,this.render()}},{key:"setData",value:function(t,n){f(e.includes(this.getPlotIds(),t),'Unknown plot ID: "'.concat(t,'"')),f(e.isArray(n),"Data must be an array but is: ".concat(n));var r=e.get(this.data,t,{});r.data=n,this.data[t]=r,this.render()}},{key:"setMaxValue",value:function(t,n){f(e.includes(this.getPlotIds(),t),'Unknown plot ID: "'.concat(t,'"')),f(e.isNumber(n)||e.isUndefined(n),"Unknown value type provided: ".concat(n)),this.maxValues[t]=n,this.render()}},{key:"setSelectedBin",value:function(t){this.selectedBin=t,this.render()}}]),t}();function m(t,n){var r=t.val,a=t.mean,i=t.std,o=e.get(n,"value",{}),s=o.outlierAbove,l=void 0===s?"#00ff33":s,c=o.outlierBelow,u=void 0===c?"#ff0000":c,f=o.mean,h=void 0===f?"#eeeeee":f;if(e.isNaN(r))return"none";var d=r>a+i?l:r<a-i?u:h,g=2*Math.abs(r-a);g>1&&(g=1),g<0&&(g=0);var p=(55+Math.round(200*g)).toString(16);return d+(1===p.length?"0".concat(p):p)}var b=function(t){function a(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return r(this,a),(t=c(this,s(a).call(this,e))).margin=e.margin||{top:10,bottom:10},t.handlers=e.handlers||{},t.colours=e.colours||{overlay:{selected:"#3333330f"},value:{outlierAbove:"#00ff33",outlierBelow:"#ff0000",mean:"#eeeeee"}},t.colourFn=e.colourFn||m,t.fontSize=e.fontSize||10,t}return o(a,d),i(a,[{key:"renderLabels",value:function(t,r,a,i,o){var s=o.getUnitSize()*a,l=o.parameters.labels,c=l.offset,u=l.margin,f=n.scalePoint().domain(n.range(i.length)).rangeRound([this.margin.top,s-this.margin.bottom]).padding(.5);t.selectAll("text").data(function(t){return t.data}).join("text").attr("transform",function(t,e){return"translate(0, ".concat(f(e),")")}).attr("dy","0.35em").attr("x",c-u).attr("text-anchor","end").style("font-size","".concat(this.fontSize,"px")).style("cursor","pointer").text(function(t){return t}).on("click",function(t,n){var a=o.parameters.handlers.onLabelClicked;(void 0===a?e.noop:a)(r,n)}).on("mouseover",function(){n.select(this).attr("font-weight","bold")}).on("mouseout",function(){n.select(this).attr("font-weight",void 0)})}},{key:"renderStep",value:function(t,r,a,i,o,s){var l=this,c=s.getUnitSize()*a,u=c-this.margin.top-this.margin.bottom,f=(i[o]||[]).length,h=u/f,d=s.getBinWidth(),g=e.min([h,d])/2*.95,p=n.scalePoint().domain(n.range(f)).rangeRound([this.margin.top,c-this.margin.bottom]).padding(.5);t.selectAll("g.values").data(function(t){return[t.data||[]]}).join("g").attr("class","values").attr("transform","translate(".concat(d/2,", 0)")).selectAll("circle").data(function(t){var e=n.deviation(t),r=n.mean(t);return t.map(function(t){return{val:t,mean:r,std:e}})}).join("circle").attr("cx",0).attr("cy",function(t,e){return p(e)}).attr("fill",function(){return l._getColour.apply(l,arguments)}).attr("r",function(t){return parseFloat(t.val)>0?t.val*g:0});var v=this.colours;t.selectAll("g.hotspots").data(function(t){return[t.data||[]]}).join("g").attr("class","hotspots").attr("transform","translate(".concat(d/2,", 0)")).selectAll("circle").data(function(t,e){return t.map(function(t){return{value:t,stepIndex:e}})}).join("circle").attr("cy",function(t,e){return p(e)}).attr("fill","none").attr("r",g).on("mouseover",function(){n.select(this).style("fill",v.overlay.selected)}).on("mouseout",function(){n.select(this).style("fill","none")}).on("click",function(t,n){var a=l.handlers.onValueClicked;(void 0===a?e.noop:a)(r,n,o)})}},{key:"_getColour",value:function(t){return this.colourFn(t,this.colours)}}]),a}(),y=function(t){return t},x=function(t){function a(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return r(this,a),(t=c(this,s(a).call(this,e))).margin=e.margin||{top:10,bottom:1,left:2,right:2},t.handlers=e.handlers||{},t.colours=e.colours||{bars:["#99999955","#999999"],font:"#550",bubble:"#bbbbbbcc",bubbleStroke:"#bbbbbbff"},t.fontSize=e.fontSize||10,t}return o(a,d),i(a,[{key:"renderLabels",value:function(t,r,a,i,o){var s=this,l=o.getUnitSize()*a,c=o.parameters.labels,u=c.offset,f=c.margin,h=n.scalePoint().domain(n.range(i.length)).rangeRound([this.margin.top,l-this.margin.bottom]).padding(.5),d=t.selectAll("g.label").data(function(t){return e.reverse(e.clone(t.data))}).join("g").attr("class","label").attr("transform",function(t,e){return"translate(".concat(u-f-5,", ").concat(h(e),")")}).attr("dy","0.35em");d.selectAll("text").data(function(t){return[t]}).join("text").attr("text-anchor","end").text(function(t){return t});d.selectAll("rect").data(function(t,e){return[e]}).join("rect").attr("x",4).attr("y",-10).attr("width",10).attr("height",10).attr("fill",function(t){return s.colours.bars[t]})}},{key:"renderStep",value:function(t,r,a,i,o,s,l,c){var u=this,f=s.getUnitSize()*a,h=s.getBinWidth(),d=.9*h,g=(h-d)/2,p=f-this.margin.bottom-this.margin.top;i=i.map(function(t){return e.isArray(t)?t:[t]});var v=n.scaleLinear().domain(function(t,r){if(0===t.length)return[0,1];var a=n.max(t.map(function(t){return e.isArray(t)?n.max(t):t})),i=n.min(t.map(function(t){return e.isArray(t)?n.min(t):t}));return[i<0?i:0,e.isFinite(r)?r:a]}(i,c)).range([p,0]);t.on("mouseover",function(t){var n=s.getOverlayForPlot(r),a=t.data;n.selectAll("g.hotspot").attr("opacity",1).attr("transform","translate(".concat(l,", ").concat(p-3.5*u.fontSize,")")).selectAll("text").data(e.reverse(e.clone(a))).join("text").attr("transform","translate(".concat(-h,", 0)")).attr("text-anchor","middle").attr("dy",function(t,e){return u.fontSize*(e+1)+u.fontSize/2}).attr("dx",h/2).style("font-size","".concat(u.fontSize,"px")).style("font-weight","bold").text(function(t){var n=function(t){return t}(t),r=y(t);return e.round(e.isFinite(n)?n:r,2)}).attr("fill",u.colours.text).style("cursor","default")}).on("mouseout",function(){s.getOverlayForPlot(r).selectAll("g.hotspot").attr("opacity",0)}),t.selectAll("rect").data(function(t){return e.reverse(e.clone(t.data||[]))}).join("rect").attr("x",g).attr("y",function(t){return u.margin.top+v(y(t)||0)}).attr("width",d).attr("height",function(t){return p-v(y(t)||0)}).attr("fill",function(t,e){return u.colours.bars[e]})}},{key:"renderOverlay",value:function(t,n,r,a){var i=a.getBinWidth(),o=a.getUnitSize()*r;if(e.isFinite(i)){var s=t.selectAll("g.hotspot").data([null]).join("g").attr("class","hotspot").attr("transform","translate(".concat(i/2+1,", ").concat(o,")")).attr("opacity",0),l=3*this.fontSize;s.selectAll("line").data(function(t){return[t]}).join("line").attr("transform","translate(".concat(-i/2+1,", ").concat(l/2,")")).attr("x1",l/2).attr("y1",0).attr("x2",i).attr("y2",0).attr("stroke",this.colours.bubbleStroke),s.selectAll("rect").attr("transform","translate(".concat(-i,", 0)")).data(function(t){return[t]}).join("rect").attr("fill",this.colours.bubble).attr("stroke",this.colours.bubbleStroke).attr("width",l).attr("height",l).attr("x",-l/2+i/2)}}}]),a}();t.BarPlot=x,t.Explorer=v,t.HeatBubblePlot=b,Object.defineProperty(t,"__esModule",{value:!0})});